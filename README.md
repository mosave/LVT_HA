# LVT_HA

Home Assistant integration for Lite Voice Terminal

[![hacs_badge](https://img.shields.io/badge/HACS-Custom-41BDF5.svg)](https://github.com/hacs/integration)
[![Donate](https://img.shields.io/badge/donate-Yandex-orange.svg)](https://money.yandex.ru/to/)

![Lite Voice Terminal](https://github.com/mosave/LVTerminal/)

## Установка

Установка через HACS:

1. [Установите HACS](https://hacs.xyz/docs/installation/manual)
1. Перейдите в раздел HACS -> Integrations
1. Нажмите кнопку "+", расположенную в нижней правой части экрана
1. Наберите "LVT" для поиска интеграции Lite Voice Terminal и установите ее
1. Перезапустите Home Assistant

Установка вручную:

1. Скачайте файл lvt.zip из раздела [релизы][latest-release]
2. Откройте папку конфигурации Home Assistant (в которой находится файл configuration.yaml), используя привычные вам инструменты
3. Распакуйте файлы из архива с подкаталогами в папку с конфигурацией HA
4. Перезапустите Home Assistant
5. Для выполнение базовой настройки LVT через web-интерйейс HA зайдите в "Configuration" -> "Integrations", нажмите "+" в правом нижнем углу и наберите "LVT" в строке поиска
6. Для выполнения полной настройки LVT через файл конфигурации configuration.yam - читайте раздел "Настройка".

## Объекты (Entities), поддерживаемые интеграцией

### Общие

- **binary_sensor.lvt_online**

### Привязанные к LVT терминалам (speaker)

Каждцй терминал имеет свой уникальный идентификатор (**speaker_id**), настраиваемый на стороне сервера LVT. Интеграция отслеживает список активных LVT терминалов и создает соответствующие им устройства в Home Assistant.

Каждое устройство-терминал (device) обладает следующим набором объектов:

- **binary*sensor.lvt*<speaker_id>\_online**
- **number.lvt\_<speaker_id>\_volume**
- **select.lvt\_<speaker_id>\_filter**
  0: Озвучивать все сообщения без исключений
  1: Озвучивать информационные сообщения
  2: Озвучивать только важные сообщения
  3: Озвучивать только критически важные сообщения (пожар, протечка)
  4: Не озвучивать сообщения, инициированные на стороне сервера

## Сервисы

При описании сервисов используются параметры:

- **<speaker_id>**: Идентификатор или список идентификаторов терминалов. Если параметр не задан то используются все активные терминалы с соответствующими настройками уровня фильтра важности.
  В качестве идентификатора можно указать:
  - speaker_id, ID LVT терминала
  - device_id, ID соответствующего устройства Home Assistant
  - entity_id либо unique_id любого компонента терминала (volume, filter, online).
  - area_id: ID локации, в которой установлены терминалы
- **<importance>**: Уровень важности сообщения. Текст будет проговорен только на терминалах с соответствующим уровенем фильтрации
  - 0: Неважная болтовня (текущее время, здрасте-досвидания и тд)
  - 1: Информационное сообщение
  - 2: Важное сообщение (звонок в дверь)
  - 3: Критически важное сообщение (пожар, протечка)
- **<text>**: фраза или список фраз для проговаривания. Если список содержит несколько фраз то LVT выберет одну из них случайным образом
- **<sound_effect>**: Имя звукового эффекта. Соответствующие .wav файлы находятся в каталогах /config или /lvt/sounds
- **<utterance>**: Ключевая фраза или список ключевых фраз. Язык описания ключевых фраз описан ниже

**Проиграть звуковой эффект на терминалах**

```
lvt.play
    speaker: <speaker_id>                   # Список терминалов, на которых необходимо проговорить фразу
    importance: <importance>                # Важность сообщения (обязательный параметр)
    play: <sound_effect>
```

**Проговорить текст на терминалах**

```
lvt.say
    speaker: <speaker_id>                   # Список терминалов, на которых необходимо проговорить фразу
    importance: <importance>                # Важность сообщения (обязательный параметр)
    say: <text>
```

**Диалог выбора одного варианта из нескольких возможных**

```
lvt.negotiate
    speaker: <speaker_id>                   # Список терминалов, на которых нужно запустить диалог (по умолчанию - на всех)
    importance: <importance>                # Уровень важности
    say: <text>                             # Текст, проговариваемый при начале диалога
    prompt: <text>                          # Текст, проговариваемый если от пользователь игнорирует вопрос
                                            # Описание первого из возможноых вариантов выбора
    option_1_intent: <intent_id>            # Интент, вызываемый при выборе первого варианта
    option_1_utterance: <utterance>         # Ключевые фразы для выбора первого варианта
    option_1_say: <text>                    # Сообщения, подтверждающие выбор первого варианта (необязательный)
    option_1_data: <data>                   # Дополнительные данные при выборе первого варианта (необязательный)
                                            # Описание второго варианта выбора (см. выше)
    option_2_intent: <intent_id>
    option_2_utterance: <utterance>
    option_2_say: <text>
    option_2_data: <data>
        .....
                                            # Описание последнего варианта выбора (см. выше)
    option_N_intent: <intent_id>
    option_N_utterance: <utterance>
    option_N_say: <text>
    option_N_data: <data>

    default_intent: <intent_id>             # Интент, вызываемый при истечении времени ожидания (необязательный)
    default_timeout: <seconds>              # Время (в секундах), в течение которого пользователю необходимо дать ответ (по умолчанию 30 секунд)
    default_utterance: <utterance>          # Ключевые фразы для оказа от выбора до истечения времени ожидания (необязательный)
    default_say: <text>                     # Сообщение, подтверждающее отказ от выбора (необязательный)
    default_data: <data>                    # Дополнительные данные при истечении времени ожидания (необязательный)
```

**Подтверждение согласия**

```
lvt.confirm
    speaker: <speaker_id>                   # Список терминалов, на которых нужно запустить диалог (необязательный)
    importance: <importance>                # Уровень важности
    say: <text>                             # Текст, проговариваемый при начале диалога
    prompt: <text>                          # Текст, проговариваемый если от пользователь игнорирует вопрос (необязательный)
    yes_intent: <intent_id>                 # Интент, вызываемый при выражении согласия (необязательный)
    yes_say: <text>                         # Сообщения, подтверждающие выбор первого варианта (необязательный)
    yes_data: <text>                        # Дополнительные данные (необязательный)
    no_intent: <intent_id>                  # Интент, вызываемый при отказе (необязательный)
    no_say: <text>                          # Сообщение, подтверждающее отказ (необязательный)
    no_data: <text>                         # Дополнительные данные (необязательный)
    default_intent: <intent_id>             # Интент, вызываемый при отказе пользователя сделать выбор (необязательный)
    default_timeout: <seconds>              # Время (в секундах), в течение которого пользователю необходимо дать ответ (по умолчанию 30 секунд)
    default_utterance: <utterance>          # Ключевые фразы для оказа от выбора до истечения времени ожидания (необязательный)
    default_say: <text>                     # Сообщение, подтверждающее отказ от выбора
    default_data: <data>                    # Дополнительные данные при истечении времени ожидания
```

**Перезагрузка или обновление терминала LVT**

```
lvt.restart_speaker
    speaker: <speaker_id>                   # Список терминалов, на которых нужно перезагрузить (обновить)
    update: <true|false>                    # Обновить версию LVT терминала
    say: <text>                             # Текст, проговариваемый перед началом перезагрузки (обновления)
    say_on_restart: <text>                  # Текст, проговариваемый после завершения перезагрузки (обновления)
```

### Примеры вызова сервисов LVT

## Взаимодействие (организации диалога) с LVT

### Стандартный Intent Script

```
intent_script:
  <intent_id>:
    action:
      ...
    speech:
      ...
```

### Триггеры в автоматизациях

Интенты LVT можно использовать в качестве триггеров при описании своих автоматизаций

```
automation:
  trigger:
    - platform: lvt
      intent: <intent_id>   # Обязательный
      speaker: <speaker4>  # (Список) терминалов, от которы получен Intent
      data:
        <var1>: <value1> # Проверка значениий поля данных (слот)) в intent на соответствие значению <var1>
        <var2>: <value2>
        ...

  action:
    - service: persistent_notification.create
      data:
        message: "CancelIntent"
        title: "Automation 1"
```

## Настройка

При установке интеграции через WEB интерфейс доступны только базовые настройки интеграции с LVT: отслеживание и отображение состояния терминалов, сервисы вывода голосовых сообщений и базовые диклоги.

Однако для тонкой настройки голосового взаимодействия Home Assistant с человеком с помощью LVT требуется редактирование файлов конфигурации.

Настройки соединения с LVT API сервером:

```
lvt
    server: <LVT server address or host name>
    port: <port number, default is 7999>
    password: <password to connect>
    ssl: <ssl_mode>

```

Возможные значения **<ssl_mode>**. Сервер LVT так же должен быть настроен соответствующим образом (параметры SSLCertFile / SSLKeyFile)

- 0: шифрация канала не используется. Используйте этот режим с большой осторожностью и только в тех случаях,
  когда доступ к LVT сервер извне локальной сети невозможен.
- 1: канал связи с LVT сервером зашифрован самоподписанным SSL сертификатом, валидация сертификата отключена
- 2: канал связи зашифрован валидируемым SSL сертификатом.

```
lvt:
  intents:
    - id: <intent_id>
      speaker: <speaker_id>
      utterance: <utterance>
      data: <data>
```

```
lvt:
    intent:
      id: <intent_id>
      speaker: <speaker_id>
      utterance: <utterance>
      data: <data>
```

## Язык описания ключевых фраз (utterance)

```
<utterance> ::=  UTTERANCE {UTTERANCE}
UTTERANCE ::= WORD | [SLOT:]"?" | [SLOT:]"*" | [SLOT=]"["LIST"]" | [SLOT=]"<"DICTIONARY">"
LIST ::= [VALUE=]WORD {WORD} { "," [VALUE=] WORD {WORD} }

WORD   - слово на распознаваемом языке, зависит от конфигурации сервера
"?"    - одно любое слово на распознаваемом языке
"*"    - ноль или больше слов на распознаваемом языке
SLOT   - название слота (переменной), возвращаемой после разбора фразы.
VALUE  - значение слота (переменной), возвращаемое при распознавании одной из фраз в списке.


Пользовательские справочники описываются в конфигурации LVT сервера в файлах с расширением .entity
Так, например, при использовании в фразе слова <location>, LVT будет искать совпадение одного из определений,
описанных в файле location.entity и при обнаружении вернет соответствующий ID определения.

Кроме пользовательских справочников, планируется реализация следующих "псевдо" справочников:
    <integer> - целое число
    <number> - целое число или десятичная дробь
    <time> - описание даты или времени

```

Примеры:
"включи свет в location=<Locations>"
"action=[on=включи,off=выключи] свет в location=<Locations>"
"включи color=[00FF00=зеленый,0000FF=синий,FFFFFF=яркий,404040=приглушенный] свет"
"Сколько сейчас времени"
"Выключи свет <time>"

## Отказ от ответственности
